[![img](https://img.shields.io/badge/Lifecycle-Maturing-007EC6)](https://github.com/bcgov/repomountie/blob/master/doc/lifecycle-badges.md)
[![img](https://img.shields.io/badge/Lifecycle-Maturing-007EC6)](https://github.com/bcgov/repomountie/blob/master/doc/lifecycle-badges.md)
[![License](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](LICENSE)

# LCRB Digital Age Verification Service ([lcrb-dav](https://hackmd.io/@esune/SywrtDQvp))

A verifier application to enable the Digital Age Verification process involving the BC Person credential. This application is designed so that it can also be used for other use cases involving different presentation request template.

See [here](https://hackmd.io/@esune/SywrtDQvp) for more background and architectural info.

[Running lcrb-dav](#running-lcrb-dav) will standup an `aca-py` service with it's associated storage, `controller` service with it's FastAPI backend, vanilla JavaScript frontedn relying on Jinja2 template and polling `GET` endpoints, and Mongo database.

## Pre-requisites

- A bash-compatible shell such as [Git Bash](https://git-scm.com/downloads)
- [Docker](https://docs.docker.com/get-docker/)
- Ngrok token (optional, required for local development)

## Configuring Ngrok

Each developer must apply for an Ngrok token [here](https://dashboard.ngrok.com/get-started/your-authtoken). Then place the token into the .env-dev file within the docker directory.

```
NGROK_AUTHTOKEN=<your token here>
```

## Running lcrb-dav

Open a shell in the [docker](docker/) folder and run the following commands:

- `./manage build`: this command will build the controller image. This step is required the first time the project is run, and when dependencies in change in the requirements file(s).
- `./manage start`: this will start the project.
- To reset everything (including removing container data and selected options in the `env` file) execute `./manage rm`.

A list of all available commands is visible by executing `./manage -h`.

The project is set-up to run without needing any external dependencies by default, using a standalone agent in read-only that will target the ledgers specified in [ledgers.yaml](docker/agent/config/ledgers.yaml).

## Using lcrb-dav

Before starting up lcrv-dav, a couple of things need to be considered:

- A proof configuration yaml [proof_config.yaml](/docker/dav-controller/proof_config.yaml) is located at `/docker/dav-controller/proof_config.yaml`. This specifies the proof request template which will be used to generate the actual requests and corresponding QR codes. As seen with example yaml config below, it is possible to specify multiple proof request templates:
  - `age-verification-bc-person-credential` and `age-verification-bc-person-credential-more-info` are the proof config identifiers.
  - `proof-request` specifies the template for the proof request generation.
    - Certain values related to datetime need to calculated in realtime and dynmaically updated before proof request is created. `$now` [current datetime as integer] and `$threshold_date_19` [19 yr back birthdate as integer] are currently supported for this.
    - Labels for `request_attributes` and `request_predicates` are autogenerated and updated.
  - `ui-revealed-attribs` specifies which attribs need to be revealed in the UI
  - `display-text` specifies the header text to shown in the UI
  ```
  age-verification-bc-person-credential:
    proof-request:
      name: age-verification
      version: "1.0"
      requested_attributes:
        - names: 
            - picture
          restrictions:
            - schema_name: Person
          non_revoked: 
            from: $now
            to: $now
      requested_predicates:
        - name: birthdate_dateint
          p_type: <=
          p_value: $threshold_date_19
          restrictions:
            - schema_name: Person
          non_revoked: 
            from: $now
            to: $now
    ui-revealed-attribs:
      - picture
    display-text: Scanning this QR code will verify age and identity.
  age-verification-bc-person-credential-more-info:
    proof-request:
      name: age-verification-more-info
      version: "1.0"
      requested_attributes:
        - names: 
            - picture
            - given_names
            - family_name
            - country
          restrictions:
            - schema_name: Person
          non_revoked: 
            from: $now
            to: $now
      requested_predicates:
        - name: birthdate_dateint
          p_type: <=
          p_value: $threshold_date_19
          restrictions:
            - schema_name: Person
          non_revoked: 
            from: $now
            to: $now
    ui-revealed-attribs:
      - picture
      - given_names
      - family_name
      - country
    display-text: Scanning this QR code will verify age and reveal name, country and picture.
  ```
- lcrb-dav verifier application currently only supports one proof type at runtime. This is specified by updating the following in [/docker/manage L145-146](/docker/manage)
  ```
  ## proof configuration selection
  export DAV_PROOF_CONFIG_ID="age-verification-bc-person-credential"
  ```
- When running locally the application will be accessible at `http://localhost:5000/`. </br>
Scan the QR code with BC Wallet application and proceed with the on screen instruction to complete the present-proof exchange and verify yourself. </br>
If needed, you can obtain a Person Credential from the [BC Wallet Showcase](https://digital.gov.bc.ca/digital-trust/showcase) by completing the lawyer demo.

## Environment Variables

Several functions in lcrb-dav can be tweaked by using the following environment variables.

| Variable                 | Type | What it does                                                |NOTES|
| ------------------------ | ---- | ---------------------------------------------- |-|
| USE_OOB_PRESENT_PROOF    | bool | if True, the present-proof request will be provided as a an [out of band](https://github.com/hyperledger/aries-rfcs/tree/main/features/0434-outofband) invitation with a [present-proof](https://github.com/hyperledger/aries-rfcs/tree/main/features/0037-present-proof) request inside. If False, the present-proof request will be use the [service-decorator](https://github.com/hyperledger/aries-rfcs/tree/main/features/0056-service-decorator)|**TRUE:** BC Wallet supports our OOB Message with a minor glitch, BiFold, Lissi, Trinsic, and Estatus all read the QR code as 'Invalid' **FALSE:** Works with|
| LOG_WITH_JSON            | bool | If True, logging output should printed as JSON if False it will be pretty printed.| Default behavior will print as JSON. |
| LOG_TIMESTAMP_FORMAT     | string | determines the timestamp formatting used in logs | Default is "iso" |
| LOG_LEVEL                | "DEBUG", "INFO", "WARNING", or "ERROR" | sets the minimum log level that will be printed to standard out| Defaults to DEBUG |
| DAV_PROOF_CONFIG_ID                | "age-verification-bc-person-credential" | sets the proof template config to be used | Defaults to "age-verification-bc-person-credential" |